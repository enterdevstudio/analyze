#!/bin/bash

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:$PATH

source /etc/journeymonitor/app-analyze-env.sh

mkdir -p /opt/journeymonitor/analyze

cd $2

/usr/bin/cqlsh ${JOURNEYMONITOR_ANALYZE_CASSANDRA_CQLSH_HOST} -e "CREATE KEYSPACE IF NOT EXISTS test WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };" || exit 1

/usr/bin/cqlsh ${JOURNEYMONITOR_ANALYZE_CASSANDRA_CQLSH_HOST} -e "CREATE KEYSPACE IF NOT EXISTS analyze WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };" || exit 1

/usr/bin/sbt "project common" "run" || exit 1 # This applies Pillar migrations for test and prod env
/usr/bin/sbt "project common" "test" || exit 1
/usr/bin/sbt "project importer" "assembly" || exit 1 # This also runs all tests
/usr/bin/sbt "project spark" "assembly" || exit 1 # This also runs all tests
/usr/bin/sbt "project api" "test" "universal:packageZipTarball" || exit 1

cp importer/target/scala-2.11/journeymonitor-analyze-importer-assembly.jar /opt/journeymonitor/analyze/
cp spark/target/scala-2.11/journeymonitor-analyze-spark-assembly.jar /opt/journeymonitor/analyze/

cp api/target/universal/api-1.0-SNAPSHOT.tgz /opt/journeymonitor/analyze/
/bin/kill `cat /var/tmp/journeymonitor-analyze-api.pid`
/bin/sleep 10
cd /opt/journeymonitor/analyze/
/bin/tar xvfz api-1.0-SNAPSHOT.tgz
/bin/su -s /bin/bash -c ". /etc/journeymonitor/app-analyze-env.sh && /usr/bin/nohup /bin/bash /opt/journeymonitor/analyze/api-1.0-SNAPSHOT/bin/api >> /var/tmp/journeymonitor-analyze-api.log 2>&1 &" journeymonitor || exit 1
